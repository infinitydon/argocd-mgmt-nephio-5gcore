apiVersion: kpt.dev/v1
kind: Kptfile
metadata: # kpt-merge: /controlplane
  name: controlplane
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    config.kubernetes.io/local-config: "true"
    internal.kpt.dev/upstream-identifier: 'kpt.dev|Kptfile|default|controlplane'
upstream:
  type: git
  git:
    repo: https://github.com/infinitydon/nephio-aws-packages.git
    directory: workload-cluster-package-free5gc
    ref: r3-argocd
upstreamLock:
  type: git
  git:
    repo: https://github.com/infinitydon/nephio-aws-packages.git
    directory: workload-cluster-package-free5gc
    ref: r3-argocd
    commit: f03897787ca65a4980df9baa24843459b302584a
info:
  description: this package is used to deploy workload cluster via FluxCD TF controller
pipeline:
  mutators:
  - name: PackageVariant.controlplane-eks-cluster..0
    image: gcr.io/kpt-fn/search-replace:v0.2.0
    configMap:
      by-value: IRSA_ARN
      put-value: arn:aws:iam::989405826384:role/mgmt-argocd-terraform-runner
    selectors:
    - kind: Terraform
  - name: PackageVariant.controlplane-eks-cluster..1
    image: gcr.io/kpt-fn/apply-setters:v0.2.0
    configMap:
      aws-region: us-west-2
      eks-cluster-name: ctrlplane
      eks-version: '"1.31"'
      free5gc-kernel: disable
      instance-type: m5.4xlarge
      parameter-store-name: control-plane-5g
      tf-backend-config: |-
        terraform {
          backend "kubernetes" {
            secret_suffix    = "ctrlplane-cluster"
            in_cluster_config  = true
            namespace = "tf-system"
          }
        }
      tf-cluster-name: controlplane-cluster
      tf-secret-output-name: controlplane-cluster-tf-output
